/*! app | Functions  */

var breakpoint_small    = 600;
var breakpoint_medium   = 900;
var breakpoint_xxlarge  = 2000;

// vanilla js version of  jQuery $(document).ready()
function domReady () {
  document.body.className += " javascript";
  // ...
}

// Mozilla, Opera, Webkit
if ( document.addEventListener ) {
  document.addEventListener( "DOMContentLoaded", function(){
    document.removeEventListener( "DOMContentLoaded", arguments.callee, false);
    domReady();
  }, false );

// If IE event model is used
} else if ( document.attachEvent ) {
  // ensure firing before onload
  document.attachEvent("onreadystatechange", function(){
    if ( document.readyState === "complete" ) {
      document.detachEvent( "onreadystatechange", arguments.callee );
      domReady();
    }
  });
}

function unquote(str, quoteChar) {
    quoteChar = quoteChar || '"';
    if (str[0] === quoteChar && str[str.length - 1] === quoteChar)
        return str.slice(1, str.length - 1);
    else return str;
}

function getScrollBarWidth() {
  var inner = document.createElement('p');
  inner.style.width = "100%";
  inner.style.height = "200px";

  var outer = document.createElement('div');
  outer.style.position = "absolute";
  outer.style.top = "0px";
  outer.style.left = "0px";
  outer.style.visibility = "hidden";
  outer.style.width = "200px";
  outer.style.height = "150px";
  outer.style.overflow = "hidden";
  outer.appendChild (inner);

  document.body.appendChild (outer);
  var w1 = inner.offsetWidth;
  outer.style.overflow = 'scroll';
  var w2 = inner.offsetWidth;
  if (w1 == w2) w2 = outer.clientWidth;

  document.body.removeChild (outer);

  return (w1 - w2);
};

// //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// create CSS Selector
// //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function createCSSSelector (selector, style) {
  if (!document.styleSheets) return;
  if (document.getElementsByTagName('head').length == 0) return;

  var styleSheet,mediaType;

  if (document.styleSheets.length > 0) {
    for (var i = 0, l = document.styleSheets.length; i < l; i++) {
      if (document.styleSheets[i].disabled)
        continue;
      var media = document.styleSheets[i].media;
      mediaType = typeof media;

      if (mediaType === 'string') {
        if (media === '' || (media.indexOf('screen') !== -1)) {
          styleSheet = document.styleSheets[i];
        }
      }
      else if (mediaType=='object') {
        if (media.mediaText === '' || (media.mediaText.indexOf('screen') !== -1)) {
          styleSheet = document.styleSheets[i];
        }
      }

      if (typeof styleSheet !== 'undefined')
        break;
    }
  }

  if (typeof styleSheet === 'undefined') {
    var styleSheetElement = document.createElement('style');
    styleSheetElement.type = 'text/css';
    document.getElementsByTagName('head')[0].appendChild(styleSheetElement);

    for (i = 0; i < document.styleSheets.length; i++) {
      if (document.styleSheets[i].disabled) {
        continue;
      }
      styleSheet = document.styleSheets[i];
    }

    mediaType = typeof styleSheet.media;
  }

  if (mediaType === 'string') {
    for (var i = 0, l = styleSheet.rules.length; i < l; i++) {
      if(styleSheet.rules[i].selectorText && styleSheet.rules[i].selectorText.toLowerCase()==selector.toLowerCase()) {
        styleSheet.rules[i].style.cssText = style;
        return;
      }
    }
    styleSheet.addRule(selector,style);
  }
  else if (mediaType === 'object') {
    var styleSheetLength = (styleSheet.cssRules) ? styleSheet.cssRules.length : 0;
    for (var i = 0; i < styleSheetLength; i++) {
      if (styleSheet.cssRules[i].selectorText && styleSheet.cssRules[i].selectorText.toLowerCase() == selector.toLowerCase()) {
        styleSheet.cssRules[i].style.cssText = style;
        return;
      }
    }
    styleSheet.insertRule(selector + '{' + style + '}', styleSheetLength);
  }
}

// //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Debouncing
// //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*
(function($,sr){

  var debounce = function (func, threshold, execAsap) {
      var timeout;

      return function debounced () {
          var obj = this, args = arguments;
          function delayed () {
              if (!execAsap)
                  func.apply(obj, args);
              timeout = null;
          };

          if (timeout)
              clearTimeout(timeout);
          else if (execAsap)
              func.apply(obj, args);

          timeout = setTimeout(delayed, threshold || 100);
      };
  }
  // smartresize
  jQuery.fn[sr] = function(fn){  return fn ? this.bind('resize', debounce(fn)) : this.trigger(sr); };

})(jQuery,'smartresize');
*/

/*
 * throttledresize: special jQuery event that happens at a reduced rate compared to "resize"
 *
 * latest version and complete README available on Github:
 * https://github.com/louisremi/jquery-smartresize
 *
 * Copyright 2012 @louis_remi
 * Licensed under the MIT license.
 *
 * This saved you an hour of work?
 * Send me music http://www.amazon.co.uk/wishlist/HNTU0468LQON
 */
(function($) {

var $event = $.event,
	$special,
	dummy = {_:0},
	frame = 0,
	wasResized, animRunning;

$special = $event.special.throttledresize = {
	setup: function() {
		$( this ).on( "resize", $special.handler );
	},
	teardown: function() {
		$( this ).off( "resize", $special.handler );
	},
	handler: function( event, execAsap ) {
		// Save the context
		var context = this,
			args = arguments;

		wasResized = true;

		if ( !animRunning ) {
			setInterval(function(){
				frame++;

				if ( frame > $special.threshold && wasResized || execAsap ) {
					// set correct event type
					event.type = "throttledresize";
					$event.dispatch.apply( context, args );
					wasResized = false;
					frame = 0;
				}
				if ( frame > 9 ) {
					$(dummy).stop();
					animRunning = false;
					frame = 0;
				}
			}, 30);
			animRunning = true;
		}
	},
	threshold: 0
};

})(jQuery);

// //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Pathloader  ////////////////////////////////////////////////////////////////
// //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function PathLoader( el ) {
    this.el = el;
    // clear stroke
    this.el.style.strokeDasharray = this.el.style.strokeDashoffset = this.el.getTotalLength();
}

PathLoader.prototype._draw = function( val ) {
    this.el.style.strokeDashoffset = this.el.getTotalLength() * ( 1 - val );
}

PathLoader.prototype.setProgress = function( val, callback ) {
    this._draw(val);
    if( callback && typeof callback === 'function' ) {
        // give it a time (ideally the same like the transition time) so that the last progress increment animation is still visible.
        setTimeout( callback, 200 );
    }
}

PathLoader.prototype.setProgressFn = function( fn ) {
    if( typeof fn === 'function' ) { fn( this ); }
}

// add to global namespace
window.PathLoader = PathLoader;

/*============================================================================
  Money Format
  - Shopify.format money is defined in option_selection.js.
    If that file is not included, it is redefined here.
==============================================================================*/

if ((typeof Shopify) === 'undefined') { Shopify = {}; }
if (!Shopify.formatMoney) {
  Shopify.formatMoney = function(cents, format) {
    var value = '',
        placeholderRegex = /\{\{\s*(\w+)\s*\}\}/,
        formatString = (format || this.money_format);

    if (typeof cents == 'string') {
      cents = cents.replace('.','');
    }

    function defaultOption(opt, def) {
      return (typeof opt == 'undefined' ? def : opt);
    }

    function formatWithDelimiters(number, precision, thousands, decimal) {
      precision = defaultOption(precision, 2);
      thousands = defaultOption(thousands, ',');
      decimal   = defaultOption(decimal, '.');

      if (isNaN(number) || number == null) {
        return 0;
      }

      number = (number/100.0).toFixed(precision);

      var parts   = number.split('.'),
          dollars = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + thousands),
          cents   = parts[1] ? (decimal + parts[1]) : '';

      return dollars + cents;
    }

    switch(formatString.match(placeholderRegex)[1]) {
      case 'amount':
        value = formatWithDelimiters(cents, 2);
        break;
      case 'amount_no_decimals':
        value = formatWithDelimiters(cents, 0);
        break;
      case 'amount_with_comma_separator':
        value = formatWithDelimiters(cents, 2, '.', ',');
        break;
      case 'amount_no_decimals_with_comma_separator':
        value = formatWithDelimiters(cents, 0, '.', ',');
        break;
    }

    return formatString.replace(placeholderRegex, value);
  };
}


if ($('.toc').length) {
    $(function domReady($) {
        var $nav = $('.toc');
        $nav.scrollspy({
            min: $nav.offset().top,

            onEnter: function(element, position) {
                window.console.log('Scrollspy: Entering the navigation menu');
                $nav.addClass('fixed');
            },
            onLeaveTop: function(element, position) {
                window.console.log('Scrollspy: Leaving the navigation menu');
                $nav.removeClass('fixed');
            }
        });
    });
    $(function domReady($) {
        // for each element with the class 'color'
        $('main article').each(function eachElement() {
            // cache the jQuery object
            var $this = $(this);
            var position = $this.position();
            var tocClass = $this.data('id');
            //window.console.log(position);
            //window.console.log('min: ' + position.top + ' / max: ' + window.parseInt(position.top + $this.height(), 10));

            $this.scrollspy({
                min: position.top,
                max: position.top + $this.height(),
                onEnter: function onEnter(element/*, position*/) {
                    $( '.toc a.' + tocClass ).addClass('active');
                    //window.console.log('Entering ' + element.id);
                },
                onLeave: function onLeave(element/*, position*/) {
                    //window.console.log('Leaving ' + element.id);
                    $( '.toc a.' + tocClass ).removeClass('active');
                }
            });
        });
    });
}

// Reveal enter button on text entry
$("aside.search input[name='q']").keyup(function(){
 $("aside.search button[type='submit']").addClass('active');
});

$('.header-toc a').on('click', function(event) {
    //event.preventDefault();
    var currentHash = $(this).attr('href');
    var section = $(this).data('id');
    $('.help-section').animate({
        opacity: 0
    }, 250, function() {
        $( '#' + section ).animate({
            opacity: 1
        }, 250, function() {
            $('.help-section').removeClass('active');
            $('#' + section ).addClass('active');
            window.history.pushState( {} , {}, window.location.pathname + currentHash );
        });
    });
});

$( document ).ready(function() {
    $('#section-faq .answer').each(function() {
        //console.log($(this).height());
        $(this).css('height',$(this).height() + 48); // 4rem for padding-bottom added
        $(this).parent().addClass('collapsed');
    });

    $('.help-section').removeClass('active');

    if ($('#section-searchresults').length) {
        $('#section-searchresults').addClass('active');
    } else {
        if ( window.location.hash.length > 1 ) {
            $('#' + window.location.hash.substring(1) ).addClass('active');
        } else {
            $('#section-setup').addClass('active');
        }
    }

    $('#section-faq aside').on('click',function() {
        $(this).toggleClass('collapsed');
    });
});

// Expand on focus
$("textarea#ContactFormMessage").focus(function(){
    $(this).addClass('active');
});
$("textarea#ContactFormMessage").blur(function(){
    if ( $("textarea#ContactFormMessage").val() == '' ) {
        $(this).removeClass('active');
    }
});
/*
$("textarea#ContactFormMessage").on('submit',function(event){
    event.preventDefault();
});
*/
// /////////////////////////////////////////////////////////////////////////////////
// Smooth Scrolling
// /////////////////////////////////////////////////////////////////////////////////

// Select all links with hashes
$('a[href*="#"]')
  // Remove links that don't actually link to anything
  .not('[href="#"]')
  .not('[href="#0"]')
  .click(function(event) {
    // On-page links
    if (
      location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '')
      &&
      location.hostname == this.hostname
    ) {
      // Figure out element to scroll to
      var target = $(this.hash);
      target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
      // Does a scroll target exist?
      if (target.length) {
        // Only prevent default if animation is actually gonna happen
        event.preventDefault();
        $('html, body').animate({
          scrollTop: target.offset().top
        }, 1000, function() {
          // Callback after animation
          // Must change focus!
          var $target = $(target);
          $target.focus();
          if ($target.is(":focus")) { // Checking if the target was focused
            return false;
          } else {
            $target.attr('tabindex','-1'); // Adding tabindex for elements not focusable
            $target.focus(); // Set focus again
          };
        });
      }
    }
  });

// /////////////////////////////////////////////////////////////////////////////////
// Landing - Carousel
// /////////////////////////////////////////////////////////////////////////////////

var mobile_Breakpoint = 768;

function flickityNavigationColor() {
	if ( $('.slide.is-selected').hasClass('inverted') ) {
		$('.dot').addClass('inverted');
	} else {
		if ($('.dot').hasClass('inverted')) {
			$('.dot').removeClass('inverted');
		}
	}
}
var videoFrame = null;

function removeVideoOnMobile() {
    var vw = $(window).width();

    if ( vw < mobile_Breakpoint ) {
        if ( $('#shopify-section-carousel .youtube-slide').length > 0 ) {
          if ( !$('.video-container').hasClass('removed') ) {
            videoFrame = $('#shopify-section-carousel .youtube-slide');
            $('#shopify-section-carousel .youtube-slide').detach();
            $('#shopify-section-carousel .video-container').addClass('removed');
          }
        }
    } else {
        if ( $('#shopify-section-carousel .video-container').hasClass('removed') ) {
        if ( $('#shopify-section-carousel .youtube-slide').length === 0 ) {
            $(videoFrame).appendTo('#shopify-section-carousel .video-container');
            $('#shopify-section-carousel .video-container').removeClass('removed');

        	}
        }

    }
}

$(document).ready( function() {
removeVideoOnMobile();

  var $landingCarousel = $('.landing-carousel').flickity({
    "wrapAround": true,
    "watchCSS": false,
    "autoPlay": 5000,
    "prevNextButtons": false,
    "pageDots": true,
     "draggable": false,
    //"dragThreshold": 10,
    "cellSelector": '.slide'
  });
  $landingCarousel.on( 'select.flickity', function() {
      flickityNavigationColor();
  })
  flickityNavigationColor();

  $landingCarousel.on( 'staticClick.flickity', function( event, pointer, cellElement, cellIndex ) {
    // dismiss if cell was not clicked
    $landingCarousel.flickity('next');
  });

});

$(window).load( function() {
    if ( $('.landing-carousel').hasClass('init') ) {
        $('.landing-carousel').removeClass('init');
    }
});

// /////////////////////////////////////////////////////////////////////////////////
// Landing - Components
// /////////////////////////////////////////////////////////////////////////////////
/*
$(document).ready( function() {
    var coefficient = 0.9;
    if ( $(window).width() >= 2000 ) {
        coefficient = 1.1;
    }
    if ($('body').hasClass('template-index')) {
        createCSSSelector('section.components.expanded a.btn', 'transform: translateY(-' + $('section.components .intro').height() * coefficient + 'px) !important');
    }
    $(window).on("throttledresize", function( event ) {
        if ( $(window).width() >= 2000 ) {
            coefficient = 1.1;
            console.log(coefficient);
        } else {
            coefficient = 0.9;
            console.log(coefficient);
        }
        if ($('body').hasClass('template-index')) {
            createCSSSelector('section.components.expanded a.btn', 'transform: translateY(-' + $('section.components .intro').height() * coefficient + 'px) !important');
            console.log($('section.components .intro').height());
        }
    });
});
*/

if ($('body').hasClass('template-index') || $('body').hasClass('template-product')) {
	var componentCaseColors = ["gold", "copper", "silver"];
	var componentStrapColors = ["grey", "black", "nude", "green", "camel"];
	var selectedCase;
	var selectedStrap;

	var $case;
	var $strapTop;
	var $strapBottom;
	var $strapReveal;

	function initCaseColor() {
		var random = Math.abs(Math.round( (Math.random() * componentCaseColors.length) - 1));
		selectedCase = componentCaseColors[random];
		$case = $( 'section.components .case.' + selectedCase );
		$($case).addClass('active').attr("src", $($case).data('src')).removeAttr('data-src');
	}
	function initStrapColor() {
		var random = Math.abs(Math.round( (Math.random() * componentStrapColors.length) - 1));
		selectedStrap = componentStrapColors[random];
		$strapTop = $( 'section.components .strap-top.' + selectedStrap + '-' + selectedCase );
		$strapBottom = $( 'section.components .strap-bottom.' + selectedStrap );
		$strapReveal = $( 'section.components .strap-reveal.' + selectedStrap );
		$($strapTop).addClass('active').attr("src", $($strapTop).data('src')).removeAttr('data-src');
		$($strapBottom).addClass('active').attr("src", $($strapBottom).data('src')).removeAttr('data-src');
		$($strapReveal).addClass('active').attr("src", $($strapReveal).data('src')).removeAttr('data-src');
        console.log(selectedStrap);
	}
	function initMovementDials() {
		var userDate = new Date();
		var day = userDate.getDay();
		var date = userDate.getDate();
		$( 'section.components .images img.movement-day' ).addClass( 'day-' + day );
		$( 'section.components .images img.movement-date' ).addClass( 'date-' + date );
	}
	function initMovementHands() {
	  var userDate = new Date;
	  var seconds = userDate.getSeconds();
	  var minutes = userDate.getMinutes();
	  var hours = userDate.getHours();

	  // Create an object with each hand and it's angle in degrees
	  var hands = [
	    {
	      hand: 'hour',
	      angle: (hours * 30) + (minutes / 2)
	    },
	    {
	      hand: 'minute',
	      angle: (minutes * 6)
	    },
	    {
	      hand: 'second',
	      angle: (seconds * 6)
	    }
	  ];
	  // Loop through each of these hands to set their angle
	  for (var j = 0; j < hands.length; j++) {
	    var elements = document.querySelectorAll('.container-' + hands[j].hand);
	    for (var k = 0; k < elements.length; k++) {
	        elements[k].style.webkitTransform = 'rotateZ('+ hands[j].angle +'deg)';
	        elements[k].style.transform = 'rotateZ('+ hands[j].angle +'deg)';
	        // If this is a minute hand, note the seconds position (to calculate minute position later)
	        if (hands[j].hand === 'minutes') {
	          elements[k].parentNode.setAttribute('data-second-angle', hands[j + 1].angle);
	        }
	    }
	  }
	}
	function moveSecondHand() {
	  var containers = document.querySelectorAll('.hand-second');
	  setInterval(function() {
	    for (var i = 0; i < containers.length; i++) {
	      if (containers[i].angle === undefined) {
	        containers[i].angle = 6;
	      } else {
	        containers[i].angle += 6;
	      }
	      containers[i].style.webkitTransform = 'rotateZ('+ containers[i].angle +'deg)';
	      containers[i].style.transform = 'rotateZ('+ containers[i].angle +'deg)';
	    }
	  }, 1000);
	}

    $(document).ready( function() {
        if ( $(window).width() >= 2000 ) {
            coefficient = 1.1;
            console.log(coefficient);
        } else {
            coefficient = 0.9;
            console.log(coefficient);
        }
        if ($('body').hasClass('template-index')) {
            $('section.components.expanded a.btn').css('transform','translateY(-' + $('section.components .intro').height() * coefficient + 'px');
        }
    });
    $(window).on("throttledresize", function( event ) {
        if ( $(window).width() >= 2000 ) {
            coefficient = 1.1;
            console.log(coefficient);
        } else {
            coefficient = 0.9;
            console.log(coefficient);
        }
        if ($('body').hasClass('template-index')) {
            $('section.components.expanded a.btn').css('transform','translateY(-' + $('section.components .intro').height() * coefficient + 'px');
        }
    });


	function toggleComponentSection() {
		$(window).scroll(function() {
		   var hT = $('section.components').offset().top,
			   hH = $('section.components').outerHeight(),
			   wH = $(window).height(),
			   wW = $(window).width(),
			   wS = $(this).scrollTop();
               var coefficient = 0.9;
               if ( wW >= breakpoint_xxlarge ) {
                   coefficient = 1.1;
               }
		   if (wW > breakpoint_medium) {
			   if (wS > (hT+hH-wH)){
				   $('section.components').addClass('expanded');
                   $('section.components.expanded a.btn').css('transform','translateY(-' + $('section.components .intro').height() * coefficient + 'px');
			   } else {
				   if ( $('section.components').hasClass('expanded') ){
					   $('section.components').removeClass('expanded');
                       $('section.components a.btn').css('transform','');
				   }
			   }
		   } else {
			   if ( $('section.components').hasClass('expanded') ){
				   $('section.components').removeClass('expanded');
                   $('section.components a.btn').css('transform','');
			   }
		   }
		});
	}
	function fadeInElements() {

	    /* Every time the window is scrolled ... */
	    $(window).scroll( function(){

	        /* Check the location of each desired element */
	        $('.fadeIn').each( function(i){

	            var bottom_of_object = $(this).offset().top + $(this).outerHeight();
	            var bottom_of_window = $(window).scrollTop() + $(window).height();

	            /* If the object is completely visible in the window, fade it it */
	            if( bottom_of_window > bottom_of_object ){

	                $(this).animate({'opacity':'1'},500);

	            }

	        });

	    });
	}

	$(document).ready( function() {
		if ($('body').hasClass('template-index')) {
			initCaseColor();
			initStrapColor();
			fadeInElements();
			toggleComponentSection();
		}
		initMovementDials();
		initMovementHands();
		moveSecondHand();

		if ($('body').hasClass('template-index')) {
			var loader = new PxLoader(),
				caseImg = loader.addImage($('img.case.' + selectedCase).data('src')),
				strapTopImg = loader.addImage($('img.strap-top.' + selectedStrap + '-' + selectedCase).data('src')),
				strapBtmImg = loader.addImage($('img.strap-bottom.' + selectedStrap).data('src'));
			// callback that will be run once images are ready
			loader.addCompletionListener(function() {
				$( 'section.components .images' ).removeClass('init');
			});

			// begin downloading images
			loader.start();
		}
	});
    if ($('body').hasClass('template-index')) {
        $(window).on("throttledresize", function( event ) {
            toggleComponentSection();
        });
    }
}


// /////////////////////////////////////////////////////////////////////////////////
// Navigation
// /////////////////////////////////////////////////////////////////////////////////

function Menu() {
    var menuFixed = false,  //Menu fixed / unfixed
	menuQueued = false, // default menu state
    previousScroll = 0, // previous scroll position
    menuOffset = 5,   // height of menu (once scroll passed it, menu is hidden)
    detachPoint = 5,  // point of detach (after scroll passed it, menu is fixed)
    hideShowOffset = 5; // scrolling value after which triggers hide/show menu
    scrollbarOffset = 0;

    this.openMenu = open_menu;
    this.closeMenu = close_menu;
    this.toggleMenu = toggle_menu;
    this.openCart = open_cart;
    this.closeCart = close_cart;
    this.toggleCart = toggle_cart;
    //this.queue = queueMenu;
    //this.fixed = fixMenu;


    function setScrollbarOffset() {
        $(document).ready(function() {
            if (!$('body').hasClass('sub-page-build')) {
                if ( $('body').hasClass('menu--active') || $('body').hasClass('cart--active') ) {
                    $('body').css('paddingRight',getScrollBarWidth() + 'px');
                } else {
                    $('body').css('paddingRight', '');
                }
            }
        });
    }
    function toggleScrollbarOffset() {
        $(document).ready(function() {
            //if ($("body").height() > $(window).height()) {
                if ( !$('body').hasClass('offset-scrollbar') ) {
                    $('body').addClass('offset-scrollbar');
                    if (!$('body').hasClass('sub-page-build')) {
                        $('body').css('paddingRight',getScrollBarWidth() + 'px');
                        console.log(getScrollBarWidth());
                    }
                } else {
                    $('body').removeClass('offset-scrollbar');
                    $('body').css('paddingRight', '0px');
                }
            //}
        });
    }
    function preventScrolling() {
    	$('body').on('scroll mousewheel touchmove', function(e) {
    	      e.preventDefault();
    	      e.stopPropagation();
    	      return false;
    	});
    }
    function open_menu() {
        if ( !$('body').hasClass('menu--active') ) {
            $('body').addClass('menu--active');
            setScrollbarOffset();
        }
    }
    function close_menu() {
        if ( $('body').hasClass('menu--active') ) {
            $('body').removeClass('menu--active');
            setScrollbarOffset();
        }
    }
    function toggle_menu() {
		if ( $('body').hasClass('menu--active') ) {
			$('body').removeClass('menu--active');
		} else if ( $('body').hasClass('cart--active') ) {
			$('body').removeClass('cart--active');
        } else {
			$('body').addClass('menu--active');
		}
        setScrollbarOffset();
    }
    function open_cart() {
        if ( !$('body').hasClass('cart--active') ) {
            $('body').addClass('cart--active');
            setScrollbarOffset();
            ajaxCart.load();
        }
    }
    function close_cart() {
        if ( $('body').hasClass('cart--active') ) {
            $('body').removeClass('cart--active');
            setScrollbarOffset();
        }
    }
    function toggle_cart() {
		if ( $('body').hasClass('cart--active') ) {
			$('body').removeClass('cart--active');
		} else {
			$('body').addClass('cart--active');
            ajaxCart.load();
		}
        setScrollbarOffset();
    }
}

var menu = new Menu();

$(document).ready( function() {
    $('.site-nav--toggle button').on('click', function() {
        menu.toggleMenu();
    });
    $('nav.primary .backdrop').on('click', function() {
        menu.closeMenu();
        menu.closeCart();
    });
	$('a.cart-link').on('click', function(event) {
        event.preventDefault();
        menu.toggleCart();
	});
    //View Cart
    $('.toggle-cart').on('click', function(event) {
        event.preventDefault();
        menu.closeMenu();
        menu.toggleCart();
    });
});


// /////////////////////////////////////////////////////////////////////////////////
// Triggers
// /////////////////////////////////////////////////////////////////////////////////

document.addEventListener('DOMContentLoaded', function(){
	var featureGridTrigger = new ScrollTrigger({
	  toggle: {
	    visible: 'visibleClass',
	    hidden: 'hiddenClass'
	  },
	  offset: {
	    x: 0,
	    y: 20
	  },
	  addHeight: true,
	  once: true
	}, document.body, window);
});

// /////////////////////////////////////////////////////////////////////////////////
// Landing - Instagram
// /////////////////////////////////////////////////////////////////////////////////

$(document).ready( function() {
	if ($('body').hasClass('template-index')) {
		var feed = new Instafeed({
  		  target: 'instagram-feed',
  		  clientId: '659f2fca802345d992ea840c79f7b33d',
  		  //accessToken: '193715349.659f2fc.82a59147403d4a7d956d5dec874ead08',
          accessToken: '1722710591.ba4c844.d2d4f9b2690f4ce99c4856854f4c0000',
  		  get: 'user',
  		  userId: '1722710591',
  		  limit: '4',
  		  resolution: 'standard_resolution',
  		  template: '<li class="item"><a href="' + landingFeed.instafeed_link + '" style="background-image: url(' + landingFeed.instafeed_img + ')" target="_blank"></a></li>'
  	  });
  	  feed.run();
	}
});

// /////////////////////////////////////////////////////////////////////////////////
// Cookie Functions
// /////////////////////////////////////////////////////////////////////////////////

function setCookie(name,value,days) {
    var expires = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}
function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}
function eraseCookie(name) {
    document.cookie = name+'=; Max-Age=-99999999;';
}

// /////////////////////////////////////////////////////////////////////////////////
// Notification Bar
// /////////////////////////////////////////////////////////////////////////////////

$(document).ready(function() {
    //var announcementBarCookie = getCookie('announcementBar');
    //console.log(announcementBarCookie);
    if ( $("#notification-bar").length && getCookie('announcementBar') !== 'dismissed' ) {
        $("body").addClass('notification-bar-active');
        $("#notification-bar").addClass('active');
    }
});

$(".notification-bar-close").on("click touchstart", function(event) {
    event.preventDefault();
    $("#notification-bar").removeClass('active');
    $("body").removeClass('notification-bar-active');
    setTimeout(function(){
        $("#notification-bar").hide();
        refreshParallax();
    }, 500);
    setCookie('announcementBar','dismissed',1);
});

// /////////////////////////////////////////////////////////////////////////////////
// Popup
// /////////////////////////////////////////////////////////////////////////////////


$( document ).ready(function() {

	$('#mc-newsletter-popup').on('submit', function(event) {
		if(validate_input($(this))){
			register_popup($(this));
		}
        event.preventDefault();
	});

	function validate_input($form) {
		if ($form.find('input').val() == "") return false;
		else return true;
	}

	function register_popup($form) {
		$.ajax({
			type: $form.attr('method'),
			url: $form.attr('action'),
			data: $form.serialize(),
			cache: false,
			dataType: 'jsonp',
			jsonp: 'c',
			contentType: "application/json; charset=utf-8",
			error: function(err) {
              $('#mc-newsletter-popup').find('.errorText').html(err.msg);
              console.log('Error');
			},
			success: function(data) {
            	console.log(data);
                console.log('Success');
                if (data.result === "error") {
                    $('#mc-newsletter-popup .errorText').addClass('error').empty().html(data.msg.replace('0 - ', '')).fadeIn(250);
                    console.log('Success A');
                } else { // 200
                    $('#mc-newsletter-popup .errorText').removeClass('error').addClass('success').empty().html('thank you for signing up. Use code <span class="popup_newsletter_success">GOTINKER</span> at checkout.').fadeIn(250);
                    fbq('track', 'Lead');
                    setCookie('newsletterSubscriber','true', 365);
                    console.log('Success B');
                }
			}
		});
	}
});


function displayPopup() {

    var $popup = $('#popup'),
        $bg = $popup.find('.background'),
        $close = $popup.find('.close'),
        popupDelay = $('#popup').data('delay'),
        popupFrequency = $('#popup').data('frequency'),
        popupHidden = getCookie('popupHidden'),
        subscriber = getCookie('newsletterSubscriber'),
        newsletterEnabled = false;
        if ( $popup.length > 0 && popupHidden === null ) {
            newsletterEnabled = true;
            console.log('hidden');
        } else if ( Number(popupFrequency) === 0 ) {
            //console.log('zero');
            newsletterEnabled = true;
            eraseCookie('popupHidden');
            popupHidden = null;
        } else {
            console.log(Number(popupFrequency));
        }

        //console.log('popupDelay: ' + popupDelay);
        //console.log('popupFrequency: ' + popupFrequency);
        //console.log('popupHidden: ' + popupHidden);
        //console.log('subscriber: ' + subscriber);

    if (newsletterEnabled) { //popup is newsletter
        if ( subscriber === null ) {
            if ( popupHidden === null ){
                setTimeout(function(){
                    $popup.fadeIn( 250 )
                    setCookie('popupHidden','true', popupFrequency);
                }, popupDelay * 1000 );
            }
        }
    } else { //popup is not a newsletter
        if ( popupHidden === null ){
            setTimeout(function(){
                $popup.fadeIn( 250 )
                setCookie('popupHidden','true', popupFrequency);
            }, popupDelay * 1000 );
        }
    }
    $bg.click(function(){
        $popup.fadeOut(500);
    });
    $close.click(function(){
        $popup.fadeOut(500);
    });
}

$( window ).load( function() {
    displayPopup();
});



/*
function popup() {
    var $popup = $('#popup'),
        $bg = $popup.find('.background'),
        $close = $popup.find('.close');

    var newsletterEnabled = "true"
    if (newsletterEnabled) {
        //popup is newsletter
        debug('popup', 'newsletterEnabled', newsletterEnabled);
        debug('popup', 'Cookies.subscriber', Cookies.get('subscriber'));
        debug('popup', 'Cookies.popup', Cookies.get('popup'));
        if (!Cookies.get('subscriber')) {
            if (!Cookies.get('popup')) {
                setTimeout(function() {
                    $popup.fadeIn(250);
					Cookies.set('popup', '1', {
						path: '',
						expires: Number("0")
					});
                }, Number("0") * 1000);
            }
        }
    } else {
        //popup is a promotion
        if (!Cookies.get('popup')) {
            setTimeout(function() {
                $popup.fadeIn(250);
				Cookies.set('popup', '1', {
					path: '',
					expires: Number("0")
				});
            }, Number("0") * 1000);
        }
    }

    $bg.add($close).click(function() {
        $popup.fadeOut(250, function() {
		  $('#popup').remove();
		});
    });

    //mailchimp ajax
    $('#mc-newsletter-popup').ajaxChimp({
        callback: function(data) {
			debug('popup', 'data.result' ,  data.result);
			debug('popup', 'data.msg' , data.msg);
			$('#popup .description').fadeOut(250);
			if (data.result == "success") {
                $('#popup #mce-EMAIL').fadeOut(250);
				$('#popup #mc-popup-subscribe').fadeOut(250, function() {
					$('#popup #popup-success-coupon').fadeIn(250);
					$('#popup .description').empty().html("<p>Thank you! Use the code below&nbsp;for 10% off your first purchase.</p>").fadeIn(250);
				});
				Cookies.set('subscriber', true, {
					path: '',
					expires: 999
				});
            } else {
				$('#popup .description').empty().html(data.msg.replace('0 - ', '')).fadeIn(250);
			}
        }
    });
}
*/

function newsletterSignup() {
    $('#mc-newsletter-landing').ajaxChimp({
        callback: function(data) {
			debug('newsletter', 'landing_data.result' ,  data.result);
			debug('newsletter', 'landing_data.msg' , data.msg);
			$('.newsletter .description').fadeOut(250);
			if (data.result == "success") {
                $('.newsletter #mce-EMAIL').fadeOut(250);
				$('.newsletter #mc-popup-landing').fadeOut(250, function() {
				$('.newsletter #landing-success-coupon').fadeIn(250);
				$('.newsletter .description').removeClass('error').empty().html("<p>Thank you! Use the code below&nbsp;for 10% off your first purchase.</p>").fadeIn(250);
				});
				Cookies.set('subscriber', true, {
					path: '',
					expires: 999
				});
            } else {
				$('.newsletter .description').addClass('error').empty().html(data.msg.replace('0 - ', '')).fadeIn(250);
			}
        }
    });
	$('#mc-newsletter-footer').ajaxChimp({
        callback: function(data) {
			debug('newsletter', 'footer_data.result' ,  data.result);
			debug('newsletter', 'footer_data.msg' , data.msg);
			$('#footer-newsletter header').fadeOut(250);
			if (data.result == "success") {
                $('#footer-newsletter #mce-EMAIL').fadeOut(250, function() {
					$('#footer-newsletter #footer-success-coupon').fadeIn(250);
					$('#footer-newsletter header').removeClass('error').empty().html("<p>Thank you! Use the code below&nbsp;for 10% off your first purchase.</p>").fadeIn(250);
				});
				Cookies.set('subscriber', true, {
					path: '',
					expires: 999
				});
            } else {
				$('#footer-newsletter header').addClass('error').empty().html(data.msg.replace('0 - ', '')).fadeIn(250);
			}
        }
    });
}

$( document ).ready(function() {

	$('#mc-newsletter-landing').on('submit', function(event) {
		if(validate_input($(this))){
			register_landing($(this));
		}
        event.preventDefault();
	});
    $('#mc-newsletter-footer').on('submit', function(event) {
        if(validate_input($(this))){
            register_footer($(this));
        }
        event.preventDefault();
    });

	function validate_input($form) {
		if ($form.find('input').val() == "") return false;
		else return true;
	}

    function register_landing($form) {
		$.ajax({
			type: $form.attr('method'),
			url: $form.attr('action'),
			data: $form.serialize(),
			cache: false,
			dataType: 'jsonp',
			jsonp: 'c',
			contentType: "application/json; charset=utf-8",
			error: function(err) {
              $('#mc-newsletter-footer').find('.errorText').html(err.msg);
              console.log('Error');
			},
			success: function(data) {
            	//console.log(data);
                //console.log('Success');
                if (data.result === "error") {
                    $('.newsletter .description').addClass('error').empty().html(data.msg.replace('0 - ', '')).fadeIn(250);
                } else { // 200
                    $('.newsletter #mce-EMAIL').fadeOut(250);
                    $('.newsletter #mc-popup-landing').fadeOut(250);
                    $('.newsletter #landing-success-coupon').fadeIn(250);
                    $('.newsletter .description').removeClass('error').empty().html("<p>Thank you! Use the code below&nbsp;for 10% off your first purchase.</p>").fadeIn(250);
    				Cookies.set('subscriber', true, {
    					path: '',
    					expires: 999
    				});
                }
			}
		});
	}

	function register_footer($form) {
		$.ajax({
			type: $form.attr('method'),
			url: $form.attr('action'),
			data: $form.serialize(),
			cache: false,
			dataType: 'jsonp',
			jsonp: 'c',
			contentType: "application/json; charset=utf-8",
			error: function(err) {
              $('#mc-newsletter-footer').find('.errorText').html(err.msg);
              console.log('Error');
			},
			success: function(data) {
            	console.log(data);
                console.log('Success');
                if (data.result === "error") {
                    $('#footer-newsletter header').addClass('error').empty().html(data.msg.replace('0 - ', '')).fadeIn(250);
                } else { // 200
                    $('#footer-newsletter header').removeClass('error').addClass('success').empty().html('thank you for signing up.').fadeIn(250);
    				Cookies.set('subscriber', true, {
    					path: '',
    					expires: 999
    				});
                }
			}
		});
	}
});

// /////////////////////////////////////////////////////////////////////////////////
// Contact form success
// /////////////////////////////////////////////////////////////////////////////////

if ( $('.sub-page-contact .note.form-success').length || $('.sub-page-help .note.form-success').length ) {
    $('body').append('<div class="note form-success"><div class="background"></div><p class="note">Thanks for contacting us. We&quot;ll get back to you as soon as possible.</p></div>');
}
$('.note.form-success').on('click', function() {
    $(this).animate({
        opacity: 0
        }, 250, function() {
        $(this).remove();
    });
    window.history.pushState( {} , {}, window.location.pathname + '#section-contact' );
});

// /////////////////////////////////////////////////////////////////////////////////
// About Aside Height Equalization
// /////////////////////////////////////////////////////////////////////////////////

var aboutAsideHeight = 0;

$(document).ready( function() {
    if ( $('.sub-page-about').length && $(window).width() >= breakpoint_medium ) {
        $('section.secondary aside').each(function() {
            if ( $(this).height() > aboutAsideHeight ) {
                aboutAsideHeight = $(this).height();
            }
        });
        $('section.secondary aside').each(function() {
            $(this).css('height', aboutAsideHeight + 'px');
        });
    }
});

// /////////////////////////////////////////////////////////////////////////////////
// Collection quick add to cart - open cart fix
// /////////////////////////////////////////////////////////////////////////////////

jsAddToCart = function(t, r, e) {
    var r = r || 1
      , a = {
        type: "POST",
        url: "/cart/add.js",
        data: "quantity=" + r + "&id=" + t,
        dataType: "json",
        success: function(t) {
            console.log('success');
            menu.openCart();
        },
        error: function(t, r) {
            console.log('error');
        }
    };
    jQuery.ajax(a)
}

$(document).ready( function() {
    $('.template-collection button#AddToCart').on('click', function(event) {
        event.preventDefault();
        //event.stopPropagation();
        jsAddToCart($(this).data('id'), 1);
    });
    $('.template-collectionform[action^="/cart/add"]').on('submit', function(event) {
        //event.preventDefault();
        //event.stopPropagation();
    });
});
